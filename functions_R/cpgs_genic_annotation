## load libraries -----
library(annotatr)
library(GenomicRanges)

## build hg19 annotations ----
annotations<- build_annotations(genome = 'hg19',c('hg19_basicgenes','hg19_genes_intergenic'))

## function for CpGs gene annotation (output = df with cpgs and genes) ----
#data is a dataframe containing columns with "chr","start position", "end position". 
#In case of CpG positions, start position and end position are the same.
#annotations is a object resulting from build_annotations() from annotatr package.
cpgs_genes <- function(data){
  cpgsObject<-with(data,GRanges(Chr,IRanges(Pos, Pos),name = Probes)) #Probes = CpG sites
  tmp<-as.data.frame(annotate_regions(regions = cpgsObject,
                                 annotations = annotations,
                                 ignore.strand = TRUE,
                                 quiet = FALSE))
  tmp<-subset(tmp,select=c("name","annot.gene_id","annot.symbol"))
  tmp<-na.omit(unique(tmp))
  #returns dataframe of cpgs in bed format
  return(as.data.frame(cpgsObject)%>%select(seqnames,start,end))
  #returns dataframe with cpgs and genes 
  #return(tmp)
  }